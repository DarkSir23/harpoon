<%inherit file="base.html"/>
<%!
    import harpoon
    import threading
    from collections import OrderedDict
%>
<%def name="headerIncludes()">
<li class="nav-item pl-2 pt-1"><a href="#" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#confirmModal" data-description="Confirm removal from queue" data-name="Removed failed items from the queue?" data-type="failed"><i class="fa fa-remove"></i> Clear Failed</a></li>
<li class="nav-item pl-2 pt-1"><a href="#" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#confirmModal" data-description="Confirm removal from queue" data-name="Removed finished items from the queue?" data-type="completed"><i class="fa fa-remove"></i> Clear Finished</a></li>
<li class="nav-item pl-2 pt-1"><a href="#" class="btn btn-sm btn-primary" id="forcerescan"><i class="fa fa-refresh"></i> Force Rescan</a></li>
<li class="nav-item pl-2 pt-1"><a href="confirm?action=restart" class="btn btn-sm btn-warning" id="restart"><i class="fa fa-refresh"></i> Restart Harpoon</a></li>
</%def>
<%def name="body()">
<div id="msg" class="alert alert-info" style="text-align: center; padding: 8px;"></div>
<div id="active_content" class="container py-1">
</div>
<div class="container py-1"><h3>${title}</h3></div>
<div id="table-content"
     class="container">

</div>
</%def>

<%def name="javascriptIncludes()">
<script type = "text/javascript">
    $("#forcerescan").click(function() {

       // post the form values via AJAX...
       $.post('force_rescan', {}, function(data) {

          // and set the title with the result
          popupmsg(data['msg']);
       });
       return false ;
    });

</script>
<script language="javascript" type="text/javascript">
if (window.addEventListener) { // Mozilla, Netscape, Firefox
    window.addEventListener('load', loadlink, false);
} else if (window.attachEvent) { // IE
    window.attachEvent('onload', loadlink);
}
function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';

    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

    const i = Math.floor(Math.log(bytes) / Math.log(k));

    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}
function loadlink(){
    $('#table-content').load('table_content',function () {
    });
}
function loadactive(){
    $('#active_content').load('active_content', function () {
    });
}
loadlink(); // This will run on page load
loadactive();
setInterval(function(){
    loadlink() // this will run after every 2 seconds
}, 2000);
setInterval(function(){
    // loadactive()
    statusbar = $("#activebar");
    statusmeter = $("#gauge-0");
    $.getJSON('active_json', function(data, status){
        if (data.activeItem) {
            $('#active_content').show();
            $("#hash_file").html('<b>Hasfile: </b> <a href="hashfile?hash=' + data.activeItem.hash + '">' + data.activeItem.hash + '</a>');
            $('#item_name span').text(data.activeItem.name)
            if (data.activeItem.status == 'Fetching') {
                $('#fetch_row').show();
                $('#other_row').hide();
            }
            else {
                $('#fetch_row').hide();
                $('#other_row').show();
                $('#other_row').html('<b>Status: </b>' + data.activeItem.status)
            }
        }
        else {
            $('#active_content').hide();
        }
        if (data.stats) {
            $("#current_file").html('<b>Current File:</b>: ' + data.stats.currentfile)
            statusmeter.kumaGauge('update', {
                value: Math.round(data.stats.speed),
                max: Math.round(data.stats.maxspeed),
            })
            $('#finishedbar').attr('aria-valuenow', data.stats.finishedpct).css('width', Math.round(data.stats.finishedpct) + '%');
            $('#currentbar').attr('aria-valuenow', data.stats.filefinishedpct).css('width', Math.round(data.stats.filefinishedpct) + '%');
            $('#currentbar span').text(formatBytes(data.stats.trans)+'/'+formatBytes(data.stats.total));
            $('#remainingbar').attr('aria-valuenow', data.stats.fileremainderpct).css('width', Math.round(data.stats.fileremainderpct) + '%');
            $('#speedline').html('<b>Speed: </b>' + formatBytes(data.stats.speed)+'/s');

        }
    });


}, 500);
</script>
</%def>