<%!
    import harpoon
    import threading
    from collections import OrderedDict
    import datetime
    from hurry.filesize import size
%>
<%
    items = OrderedDict(sorted(harpoon.HQUEUE.ckqueue().items(), key=lambda x: x[1]['timestamp'], reverse=True))
    activeItem = None
    for key in items.keys():
        if items[key]['stage'] == 'current':
            activeItem = items[key]
%>
<%
    if harpoon.CURRENT_DOWNLOAD:
        stats = harpoon.CURRENT_DOWNLOAD.get_stats()
    else:
        stats = {'total': 0, 'trans': 0, 'currentfile': 'Error', 'percent': 0}
%>

% if activeItem:
<div class="card bg-secondary text-white">
    <div class="card-header"><h6 class="card-title">Active Item: ${activeItem['name'].replace('.',' ')}</h6></div>
    <div class="card-body">
        <div><b>Hashfile</b>: <a href="hashfile?hash=${activeItem['hash']}">${activeItem['hash']}</a></div>
        % if activeItem['status'] == 'Fetching':
        <div><b>Current File</b>: ${stats['currentfile']} (${int(stats['percent'])}%)</div>
            <div class="progress">
                <div
                        class="progress-bar progress-bar-striped progress-bar-animated"
                        role="progressbar"
                        style="width: ${int(stats['finishedpct'])}%;"
                        aria-valuenow="${stats['finishedpct']}"
                        aria-valuemin="0"
                        aria-valuemax="100"
                >
                </div>
                <div
                        class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                        role="progressbar"
                        style="width: ${int(stats['filefinishedpct'])}%;"
                        aria-valuenow="${stats['filefinishedpct']}"
                        aria-valuemin="0"
                        aria-valuemax="100"
                >
                    ${size(stats['trans'])}/${size(stats['total'])}
                </div>
                <div
                        class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                        role="progressbar"
                        style="width: ${int(stats['fileremainderpct'])}%;"
                        aria-valuenow="${stats['fileremainderpct']}"
                        aria-valuemin="0"
                        aria-valuemax="100"
                >
                </div>
            </div>
        % else:
        <b>Status</b>: ${activeItem['status']}
        % endif

    </div>
</div>
% endif